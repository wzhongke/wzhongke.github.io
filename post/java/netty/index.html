<!DOCTYPE html>
<html lang="zh-cn">

<head>

  
  <meta charset="UTF-8">
  <title>
    高并发 netty | World of Wang
  </title>


  
  <meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1">

  
  <link rel="canonical" href="https://wzhongke.github.io/post/java/netty/" />

  
  
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="//cdn.bootcss.com/highlight.js/9.12.0/styles/ocean.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://wzhongke.github.io//css/index.css">
  
  <link href="https://wzhongke.github.io/index.xml" rel="alternate" type="application/rss+xml" title="World of Wang" />
  <link href="https://wzhongke.github.io/index.xml" rel="feed" type="application/rss+xml" title="World of Wang" />

  
  <link href="https://wzhongke.github.io//favicon.ico" rel="shortcut icon">

  <script>
    window.origin = "https://wzhongke.github.io/";
    
    var outer = document.createElement('div');
    outer.style.cssText = "visibility:hidden;width:100%;overflow:scroll";
    document.documentElement.appendChild(outer);
    window.scrollWidth = outer.offsetWidth - outer.clientWidth;
    document.documentElement.removeChild(outer);
  </script>
</head>

 

<body>
  
  <div id="modal-search" class="modal">
    <div class="modal-content">
      <form>
        <div class="row">
          <div class="input-field col s12">
            <input id="in-search" type="text" required aria-required="true" autofocus autocomplete="off"/>
            <label for='in-search'>Search</label>
          </div>
        </div>
      </form>
      <div class="out-wrapper row">
        <div id="out-search" class="collection col s12"></div>
      </div>
    </div>
  </div>

  <div class="navbar-fixed">
    <nav class="navbar">
      <div class="nav-wrapper container">
        <a href="javascript:void(0)" class="button-collapse"><i class="material-icons">menu</i></a>
        <a href="https://wzhongke.github.io/" class="brand-logo"><i class="material-icons">restaurant_menu</i> 
          World of Wang
        </a>

        <ul class="right hide-on-small-and-down">
          
          <li><a class="modal-trigger" href='#modal-search'><i class="material-icons">search</i></a></li>
          <li><a href='https://wzhongke.github.io/index.xml' target="_blank"><i class="material-icons">rss_feed</i></a></li>
        </ul>
        
        <ul class="center tabs tabs-transparent hide-on-med-and-down">
          
          <li class="tab">
            <a href="https://wzhongke.github.io//" class=''>
                Home
              </a>
          </li>
          
          <li class="tab">
            <a href="https://wzhongke.github.io//archive/" class=''>
                Archive
              </a>
          </li>
          
          <li class="tab">
            <a href="https://wzhongke.github.io//about/" class=''>
                About
              </a>
          </li>
          
          <li class="tab">
            <a href="https://wzhongke.github.io//post/%E7%A2%B0%E5%88%B0%E8%BF%87%E7%9A%84%E9%97%AE%E9%A2%98/" class=''>
                碰到过的问题
              </a>
          </li>
          
        </ul>
        
      </div>
    </nav>
  </div> <aside class="side-panel">
  <div class="inner">
    <div class="profile">
      <div class="profile__bg" style="background-image:url('https://wzhongke.github.io//img/profile-bg.jpg')"></div>
      <img class="profile__avatar" src="https://wzhongke.github.io//img/sign.jpg" alt="avatar" /> 
      <h3 class="profile__name">壹冶知秋</h3> 
      <p class="profile__desc">Do not ride on fear...</p>
    </div>
    <ul class="nav-group show-on-medium-and-down menu ">
       
      <li>
        <a class="collapsible-header waves-effect waves-indigo" href="https://wzhongke.github.io//">
          <i class='material-icons'>home</i>
          <span class="content">Home</span>
          <i class="material-icons">chevron_right</i>
        </a>
      </li>
      
      <li>
        <a class="collapsible-header waves-effect waves-indigo" href="https://wzhongke.github.io//archive/">
          <i class='material-icons'>archive</i>
          <span class="content">Archive</span>
          <i class="material-icons">chevron_right</i>
        </a>
      </li>
      
      <li>
        <a class="collapsible-header waves-effect waves-indigo" href="https://wzhongke.github.io//about/">
          <i class='material-icons'>person</i>
          <span class="content">About</span>
          <i class="material-icons">chevron_right</i>
        </a>
      </li>
      
      <li>
        <a class="collapsible-header waves-effect waves-indigo" href="https://wzhongke.github.io//post/%E7%A2%B0%E5%88%B0%E8%BF%87%E7%9A%84%E9%97%AE%E9%A2%98/">
          <i class='material-icons'>bookmark</i>
          <span class="content">碰到过的问题</span>
          <i class="material-icons">chevron_right</i>
        </a>
      </li>
       
    </ul>
    <ul class="nav-group show-on-small tools">
      <li>
        <a class="collapsible-header waves-effect waves-indigo modal-trigger" href='#modal-search'>
            <i class="material-icons">search</i>
            <span class="content">Search</span>
            <i class="material-icons">chevron_right</i>
          </a>
      </li>
      <li>
        <a class="collapsible-header waves-effect waves-indigo" target="_blank" href='https://wzhongke.github.io/index.xml'>
            <i class="material-icons">rss_feed</i>
            <span class="content">RSS Feed</span>
            <i class="material-icons">chevron_right</i>
          </a>
      </li>
    </ul>
    <ul class="collapsible nav-group" data-collapsible="accordion">
      <li>
        <div class="collapsible-header waves-effect waves-indigo">
          <i class="material-icons">whatshot</i>
          <span class="content">Latest</span>
          <i class="material-icons angle">expand_more</i>
        </div>
        <div class="collapsible-body">
          <div class="collection">
            
            <a class="collection-item" href="https://wzhongke.github.io/post/front/javascript/">javascript 基础</a> 
            
            <a class="collection-item" href="https://wzhongke.github.io/post/java/netty/">高并发 netty</a> 
            
            <a class="collection-item" href="https://wzhongke.github.io/post/front/flex%E5%B8%83%E5%B1%80/">flex 布局</a> 
            
            <a class="collection-item" href="https://wzhongke.github.io/post/front/es6/">es6</a> 
            
            <a class="collection-item" href="https://wzhongke.github.io/post/front/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84javascript/">你不知道的JavaScript读书笔记</a> 
            
            <a class="collection-item" href="https://wzhongke.github.io/post/front/webpack/">webpack</a> 
            
            <a class="collection-item" href="https://wzhongke.github.io/post/algorithms/%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8C%B9%E9%85%8D%E7%AE%97%E6%B3%95/">字符串匹配算法</a> 
            
            <a class="collection-item" href="https://wzhongke.github.io/post/front/css-%E6%80%BB%E7%BB%93/">css使用方式总结</a> 
            
            <a class="collection-item" href="https://wzhongke.github.io/post/java/springlearn/">spring 学习笔记</a> 
            
            <a class="collection-item" href="https://wzhongke.github.io/post/algorithms/%E6%A0%91/">树算法</a> 
            
          </div>
        </div>
      </li>
      
      <li>
        <div class="collapsible-header waves-effect waves-indigo">
          <i class="material-icons"><i class='material-icons'>class</i></i>
          <span class="content">Category </span>
          
          <i class="material-icons angle">expand_more</i>
        </div>
        <div class="collapsible-body">
          <div class="collection">
            
            
            
            <a class="collection-item" href="https://wzhongke.github.io//categories/java"> java<span class="badge">11</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//categories/linux"> linux<span class="badge">9</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//categories/javascript"> javascript<span class="badge">7</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//categories/%E7%AE%97%E6%B3%95"> 算法<span class="badge">7</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//categories/python"> python<span class="badge">5</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"> 设计模式<span class="badge">5</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//categories/other"> other<span class="badge">4</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//categories/%E5%B7%A5%E5%85%B7"> 工具<span class="badge">3</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//categories/css"> css<span class="badge">2</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//categories/mysql"> mysql<span class="badge">2</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//categories/error"> error<span class="badge">1</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//categories/markdown"> markdown<span class="badge">1</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//categories/nodejs"> nodejs<span class="badge">1</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//categories/sql"> sql<span class="badge">1</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//categories/svg"> svg<span class="badge">1</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//categories/vue"> vue<span class="badge">1</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//categories/%E6%97%85%E8%A1%8C"> 旅行<span class="badge">1</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//categories/%E7%BC%96%E7%A8%8B"> 编程<span class="badge">1</span></a>            
            
          </div>
        </div>
      </li>
      
      <li>
        <div class="collapsible-header waves-effect waves-indigo">
          <i class="material-icons"><i class='material-icons'>local_offer</i></i>
          <span class="content">Tag </span>
          
          <i class="material-icons angle">expand_more</i>
        </div>
        <div class="collapsible-body">
          <div class="collection">
            
            
            
            <a class="collection-item" href="https://wzhongke.github.io//tags/java"> java<span class="badge">11</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//tags/linux"> linux<span class="badge">9</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//tags/javascript"> javascript<span class="badge">6</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//tags/%E7%AE%97%E6%B3%95"> 算法<span class="badge">6</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//tags/python"> python<span class="badge">5</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"> 设计模式<span class="badge">5</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//tags/other"> other<span class="badge">4</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//tags/%E5%B7%A5%E5%85%B7"> 工具<span class="badge">3</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//tags/css"> css<span class="badge">2</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//tags/markdown"> markdown<span class="badge">2</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//tags/mysql"> mysql<span class="badge">2</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//tags/error"> error<span class="badge">1</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//tags/nodejs"> nodejs<span class="badge">1</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//tags/sql"> sql<span class="badge">1</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//tags/svg"> svg<span class="badge">1</span></a>            
            
            <a class="collection-item" href="https://wzhongke.github.io//tags/%E6%97%85%E8%A1%8C"> 旅行<span class="badge">1</span></a>            
            
          </div>
        </div>
      </li>
      
    </ul>
    <ul class="nav-group external-link">
       
      <li>
        <a class="collapsible-header waves-effect waves-indigo" href="https://github.com/wzhongke" target="_blank">
          <svg class='svg-icons svg-icons-github'><use xlink:href='#svg-icons-github'></use></svg>
          <span class="content">Github<small>@wzhongke</small></span>
          <i class="material-icons">chevron_right</i>
        </a>
      </li>
       
    </ul>
  </div>
</aside>

<main id="single" role="main" class="main-panel ">
  <section class="container">
    <div class="inner">
       <div class="breadcrumbs" role="navigation" aria-label="breadcrumbs navigation">
   
   
   
  
    <a class="breadcrumb" href="https://wzhongke.github.io/"><i class="material-icons">location_on</i>Home</a>
    
       
      
      
      
       
        
          <a class="breadcrumb" href='https://wzhongke.github.io/post/'>Post</a>
         
       
    
       
      
      
      
       
        
          <a class="breadcrumb" href='https://wzhongke.github.io/post/java/'>Java</a>
         
       
    
       
      
      
      
       
        
          <span class="breadcrumb">高并发 netty</span>
         
       
    
       
      
      
      
       
     
</div>
       <section class="post-wrapper">
      <div class="toc-panel">
        <nav id="TableOfContents">
<ul>
<li><a href="#问题">问题</a></li>
<li><a href="#解决方案">解决方案</a></li>
<li><a href="#指南">指南</a>
<ul>
<li><a href="#echo-服务">ECHO 服务</a></li>
<li><a href="#http-服务器">HTTP 服务器</a></li>
</ul></li>
</ul>
</nav>
      </div>
      <div class="post">
        <div class="card">
          <div class="card-content">
            <span class="card-title">高并发 netty </span>
            <span class="card-meta">
              <time>
                
                <span>Fri Jul 20 2018</span>
            </time>
            
            <address>
              
              <a href="https://wzhongke.github.io//categories/java">java</a>&nbsp; 
              
            </address>
            
            </span>

            <article class="article">
              

<h1 id="问题">问题</h1>

<p>现在我们使用应用程序或者类库来实现系统之间的通信，比如我们使用一个HTTP客户端从 web 服务器上获取信息，使用 RPC 执行远程方法调用。。</p>

<p>然而有时候一个通用的协议和它的实现并没有覆盖一些场景。比如我们无法使用一个通用的 HTTP 服务器来实现长连接、处理大文件等。</p>

<p><strong>使用netty主要解决了http长连接的问题</strong>。</p>

<h1 id="解决方案">解决方案</h1>

<p><a href="https://netty.io/">Netty</a> 提供异步事件驱动的网络应用框架，可以快速开发高性能、高可靠的网络服务器和客户端程序。</p>

<h1 id="指南">指南</h1>

<p>目前 Netty 最新的版本是 Netty5，需要 JDK1.6 以上。</p>

<h2 id="echo-服务">ECHO 服务</h2>

<p>实现 ECHO 协议，唯一要做的就是将接收到的数据原样返回。让我们从处理器的实现开始，处理器是由 Netty 生成用来处理 I/O 事件的。</p>

<pre><code class="language-java">import io.netty.channel.ChannelHandlerAdapter;
import io.netty.channel.ChannelHandlerContext;

public class EchoServerHandler extends ChannelHandlerAdapter {

    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) {
        // 将接收到的数据原样返回
        ctx.write(msg);
        //  ctx.write(Object)方法不会使消息写入到通道上，他被缓冲在了内部，你需要调用ctx.flush()方法来把缓冲区中数据强行输出
        ctx.flush();
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) {
        // Close the connection when an exception is raised.
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>

<p>编写好处理器，那么需要启动服务：</p>

<pre><code class="language-java">import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.ChannelOption;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioServerSocketChannel;

public class EchoServer {
    private int port;

    public EchoServer(int port) {
        this.port = port;
    }

    public void run () throws InterruptedException {
        // NioEventLoopGroup 是用来处理I/O操作的多线程事件循环器
        // Netty提供了许多不同的EventLoopGroup的实现用来处理不同传输协议
        // boss 用来接收进来的连接，并将接收的连接注册到 worker 中
        EventLoopGroup bossGroup = new NioEventLoopGroup();
        // 用来处理已经被接收的连接
        EventLoopGroup workerGroup = new NioEventLoopGroup();
        try {
            ServerBootstrap b = new ServerBootstrap();
            b.group(bossGroup, workerGroup)
                .channel(NioServerSocketChannel.class)
                .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {
                    @Override
                    public void initChannel(SocketChannel ch) throws Exception {
                        ch.pipeline().addLast(new EchoServerHandler());
                    }
                })
                // option 提供给NioServerSocketChannel用来接收进来的连接
                .option(ChannelOption.SO_BACKLOG, 128)
                // childOption 是对父管道ServerChannel接收到的连接的配置
                .childOption(ChannelOption.SO_KEEPALIVE, true);

            // Bind and start to accept incoming connections.
            ChannelFuture f = b.bind(port).sync();

            // Wait until the server socket is closed.
            // In this example, this does not happen, but you can do that to gracefully
            // shut down your server.
            f.channel().closeFuture().sync();
        } finally {
            workerGroup.shutdownGracefully();
            bossGroup.shutdownGracefully();
        }
    }

    public static void main(String[] args) throws Exception {
        int port;
        if (args.length &gt; 0) {
            port = Integer.parseInt(args[0]);
        } else {
            port = 9797;
        }
        new EchoServer(port).run();
    }
}
</code></pre>

<h2 id="http-服务器">HTTP 服务器</h2>

<p>一般的HTTP服务器不支持长连接，也就是一直复用建立好的连接，如 springboot。</p>

<p>使用 netty 框架可以搭建支持长连接的HTTP服务：</p>

<pre><code class="language-java"> private HttpRequest request;
    /** Buffer that stores the response content */
    private final StringBuilder buf = new StringBuilder();

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx) {
        ctx.flush();
    }

    @Override
    protected void channelRead0(ChannelHandlerContext ctx, Object msg) {
        if (msg instanceof HttpRequest) {
            HttpRequest request = this.request = (HttpRequest) msg;

            if (HttpUtil.is100ContinueExpected(request)) {
                send100Continue(ctx);
            }

            buf.setLength(0);
            buf.append(&quot;WELCOME TO THE WILD WILD WEB SERVER\r\n&quot;);
            buf.append(&quot;===================================\r\n&quot;);

            buf.append(&quot;VERSION: &quot;).append(request.protocolVersion()).append(&quot;\r\n&quot;);
            buf.append(&quot;HOSTNAME: &quot;).append(request.headers().get(HttpHeaderNames.HOST, &quot;unknown&quot;)).append(&quot;\r\n&quot;);
            buf.append(&quot;REQUEST_URI: &quot;).append(request.uri()).append(&quot;\r\n\r\n&quot;);

            // 读取请求头
            HttpHeaders headers = request.headers();
            if (!headers.isEmpty()) {
                for (Map.Entry&lt;String, String&gt; h: headers) {
                    CharSequence key = h.getKey();
                    CharSequence value = h.getValue();
                    buf.append(&quot;HEADER: &quot;).append(key).append(&quot; = &quot;).append(value).append(&quot;\r\n&quot;);
                }
                buf.append(&quot;\r\n&quot;);
            }
            // 读取请求参数
            QueryStringDecoder queryStringDecoder = new QueryStringDecoder(request.uri());
            Map&lt;String, List&lt;String&gt;&gt; params = queryStringDecoder.parameters();
            if (!params.isEmpty()) {
                for (Entry&lt;String, List&lt;String&gt;&gt; p: params.entrySet()) {
                    String key = p.getKey();
                    List&lt;String&gt; vals = p.getValue();
                    for (String val : vals) {
                        buf.append(&quot;PARAM: &quot;).append(key).append(&quot; = &quot;).append(val).append(&quot;\r\n&quot;);
                    }
                }
                buf.append(&quot;\r\n&quot;);
            }

            appendDecoderResult(buf, request);
        }

        if (msg instanceof HttpContent) {
            HttpContent httpContent = (HttpContent) msg;

            ByteBuf content = httpContent.content();
            if (content.isReadable()) {
                buf.append(&quot;CONTENT: &quot;);
                buf.append(content.toString(CharsetUtil.UTF_8));
                buf.append(&quot;\r\n&quot;);
                appendDecoderResult(buf, request);
            }

            if (msg instanceof LastHttpContent) {
                buf.append(&quot;END OF CONTENT\r\n&quot;);

                LastHttpContent trailer = (LastHttpContent) msg;
                if (!trailer.trailingHeaders().isEmpty()) {
                    buf.append(&quot;\r\n&quot;);
                    for (CharSequence name: trailer.trailingHeaders().names()) {
                        for (CharSequence value: trailer.trailingHeaders().getAll(name)) {
                            buf.append(&quot;TRAILING HEADER: &quot;);
                            buf.append(name).append(&quot; = &quot;).append(value).append(&quot;\r\n&quot;);
                        }
                    }
                    buf.append(&quot;\r\n&quot;);
                }

                if (!writeResponse(trailer, ctx)) {
                    // If keep-alive is off, close the connection once the content is fully written.
                    ctx.writeAndFlush(Unpooled.EMPTY_BUFFER).addListener(ChannelFutureListener.CLOSE);
                }
            }
        }
    }

    private static void appendDecoderResult(StringBuilder buf, HttpObject o) {
        DecoderResult result = o.decoderResult();
        if (result.isSuccess()) {
            return;
        }

        buf.append(&quot;.. WITH DECODER FAILURE: &quot;);
        buf.append(result.cause());
        buf.append(&quot;\r\n&quot;);
    }

    private boolean writeResponse(HttpObject currentObj, ChannelHandlerContext ctx) {
        // Decide whether to close the connection or not.
        boolean keepAlive = HttpUtil.isKeepAlive(request);
        // Build the response object.
        FullHttpResponse response = new DefaultFullHttpResponse(
                HTTP_1_1, currentObj.decoderResult().isSuccess()? OK : BAD_REQUEST,
                Unpooled.copiedBuffer(buf.toString(), CharsetUtil.UTF_8));

        response.headers().set(HttpHeaderNames.CONTENT_TYPE, &quot;text/plain; charset=UTF-8&quot;);

        if (keepAlive) {
            // Add 'Content-Length' header only for a keep-alive connection.
            response.headers().setInt(HttpHeaderNames.CONTENT_LENGTH, response.content().readableBytes());
            // Add keep alive header as per:
            // - http://www.w3.org/Protocols/HTTP/1.1/draft-ietf-http-v11-spec-01.html#Connection
            response.headers().set(HttpHeaderNames.CONNECTION, HttpHeaderValues.KEEP_ALIVE);
        }

        // Encode the cookie.
        String cookieString = request.headers().get(HttpHeaderNames.COOKIE);
        if (cookieString != null) {
            Set&lt;Cookie&gt; cookies = ServerCookieDecoder.STRICT.decode(cookieString);
            if (!cookies.isEmpty()) {
                // Reset the cookies if necessary.
                for (Cookie cookie: cookies) {
                    response.headers().add(HttpHeaderNames.SET_COOKIE, ServerCookieEncoder.STRICT.encode(cookie));
                }
            }
        } else {
            // Browser sent no cookie.  Add some.
            response.headers().add(HttpHeaderNames.SET_COOKIE, ServerCookieEncoder.STRICT.encode(&quot;key1&quot;, &quot;value1&quot;));
            response.headers().add(HttpHeaderNames.SET_COOKIE, ServerCookieEncoder.STRICT.encode(&quot;key2&quot;, &quot;value2&quot;));
        }

        // Write the response.
        ctx.write(response);

        return keepAlive;
    }

    private static void send100Continue(ChannelHandlerContext ctx) {
        FullHttpResponse response = new DefaultFullHttpResponse(HTTP_1_1, CONTINUE);
        ctx.write(response);
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) {
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>

<p>以上是请求处理器。在处理请求时，需要加入一些其他的处理：</p>

<pre><code class="language-java">import io.netty.channel.ChannelInitializer;
import io.netty.channel.ChannelPipeline;
import io.netty.channel.socket.SocketChannel;
import io.netty.handler.codec.http.HttpRequestDecoder;
import io.netty.handler.codec.http.HttpResponseEncoder;
import io.netty.handler.ssl.SslContext;

public class HttpSnoopServerInitializer extends ChannelInitializer&lt;SocketChannel&gt; {

    private final SslContext sslCtx;

    public HttpSnoopServerInitializer(SslContext sslCtx) {
        this.sslCtx = sslCtx;
    }

    @Override
    public void initChannel(SocketChannel ch) {
        ChannelPipeline p = ch.pipeline();
        if (sslCtx != null) {
            p.addLast(sslCtx.newHandler(ch.alloc()));
        }
        p.addLast(new HttpRequestDecoder());
        // Uncomment the following line if you don't want to handle HttpChunks.
        p.addLast(new HttpObjectAggregator(1048576));
        p.addLast(new HttpResponseEncoder());
        // Remove the following line if you don't want automatic content compression.
        //p.addLast(new HttpContentCompressor());
        p.addLast(new HttpSnoopServerHandler());
    }
}
</code></pre>

<p>启动服务器：</p>

<pre><code class="language-java">// Configure the server.
EventLoopGroup bossGroup = new NioEventLoopGroup(1);
EventLoopGroup workerGroup = new NioEventLoopGroup();
try {
    ServerBootstrap b = new ServerBootstrap();
    b.group(bossGroup, workerGroup)
        .channel(NioServerSocketChannel.class)
        .handler(new LoggingHandler(LogLevel.INFO))
        .childHandler(new HttpSnoopServerInitializer(sslCtx));

    Channel ch = b.bind(PORT).sync().channel();

    System.err.println(&quot;Open your web browser and navigate to http://127.0.0.1:&quot; + PORT + '/');

    ch.closeFuture().sync();
} finally {
    bossGroup.shutdownGracefully();
    workerGroup.shutdownGracefully();
}
</code></pre>

            </article>

          </div>
          
          <div class="card-action">
            <i class="material-icons">local_offer</i> 
            <a class="tag" href="https://wzhongke.github.io//tags/java">#java</a>&nbsp; 
          </div>
          
          <div class="card-action">
            
 <div class="comments"><div id="disqus_thread"></div></div>

<script type="text/javascript">
     
    var disqus_shortname = 'wzhongke';

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



          </div>
        </div>
        
          <div class="pagination-single">
             
            <span class="pagination-item previous">
            <i class="material-icons">navigate_before</i>
            <a href="https://wzhongke.github.io/post/front/flex%E5%B8%83%E5%B1%80/" rel="prev">flex 布局</a>
          </span>  
          
            <span class="pagination-item next">
            <i class="material-icons">navigate_next</i>
            <a href="https://wzhongke.github.io/post/front/javascript/" rel="next">javascript 基础</a> 
          </span> 
          </div>
        
      </div>
    </section>
    </div>
  </section>
  
<footer class="page-footer">
  <div class="container">
    <div class="row">
      <div class="col l6 s12">
        <h5 class="white-text">World of Wang</h5>
        <p class="grey-text text-lighten-4">Theme <a href="https://github.com/stkevintan/hugo-YAMT-theme" target="_blank">YAMT</a> designed by <a href="https://github.com/stkevintan" target="_blank">Kevin Tan</a> with ❤</p>
      </div>
      <div class="col l4 offset-l2 s12">
        <h5 class="white-text">My Friends</h5>
        <ul>
          
          <li><a class="grey-text text-lighten-3" href="https://frantic1048.logdown.com/" target="_blank">Frantic1048</a></li>
          
        </ul>
      </div>
    </div>
  </div>
  <div class="footer-copyright">
    <div class="container">Copyright@Kevin Tan</div>
  </div>
</footer>

</main>

 
<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>
<script type="text/javascript" src="//dlweb.sogoucdn.com/common/lib/jquery/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="//cdn.bootcss.com/lunr.js/2.1.2/lunr.min.js"></script>
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']]
      }
    });
</script>
<script type="text/javascript" src="https://wzhongke.github.io//js/materialize.min.js"></script>
<script type="text/javascript" src="https://wzhongke.github.io//js/index.js"></script>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-9350854994277981",
        enable_page_level_ads: true
    });
</script>
</body>

</html>