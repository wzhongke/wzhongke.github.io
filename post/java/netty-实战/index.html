<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><title>netty 实战 | World of Wang</title><meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1"><link rel="canonical" href="https://wzhongke.github.io/post/java/netty-%E5%AE%9E%E6%88%98/"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"><link href="//cdn.bootcss.com/highlight.js/9.12.0/styles/ocean.min.css" rel="stylesheet"><link rel="stylesheet" href="https://wzhongke.github.io//css/index-ae15952095.css"><link href="https://wzhongke.github.io/index.xml" rel="alternate" type="application/rss+xml" title="World of Wang"><link href="https://wzhongke.github.io/index.xml" rel="feed" type="application/rss+xml" title="World of Wang"><link href="https://wzhongke.github.io//favicon.ico" rel="shortcut icon"><script>window.origin = "https://wzhongke.github.io/";
    
    var outer = document.createElement('div');
    outer.style.cssText = "visibility:hidden;width:100%;overflow:scroll";
    document.documentElement.appendChild(outer);
    window.scrollWidth = outer.offsetWidth - outer.clientWidth;
    document.documentElement.removeChild(outer);</script></head><body><div id="modal-search" class="modal"><div class="modal-content"><form><div class="row"><div class="input-field col s12"><input id="in-search" type="text" required aria-required="true" autofocus autocomplete="off"> <label for="in-search">Search</label></div></div></form><div class="out-wrapper row"><div id="out-search" class="collection col s12"></div></div></div></div><div class="navbar-fixed"><nav class="navbar"><div class="nav-wrapper container"><a href="javascript:void(0)" class="button-collapse"><i class="material-icons">menu</i></a> <a href="https://wzhongke.github.io/" class="brand-logo"><i class="material-icons">restaurant_menu</i> World of Wang</a><ul class="right hide-on-small-and-down"><li><a class="modal-trigger" href="#modal-search"><i class="material-icons">search</i></a></li><li><a href="https://wzhongke.github.io/index.xml" target="_blank"><i class="material-icons">rss_feed</i></a></li></ul><ul class="center tabs tabs-transparent hide-on-med-and-down"><li class="tab"><a href="https://wzhongke.github.io//" class="">Home</a></li><li class="tab"><a href="https://wzhongke.github.io//archive/" class="">Archive</a></li><li class="tab"><a href="https://wzhongke.github.io//about/" class="">About</a></li><li class="tab"><a href="https://wzhongke.github.io//post/%E7%A2%B0%E5%88%B0%E8%BF%87%E7%9A%84%E9%97%AE%E9%A2%98/" class="">碰到过的问题</a></li></ul></div></nav></div><aside class="side-panel"><div class="inner"><div class="profile"><div class="profile__bg" style="background-image:url('https://wzhongke.github.io//img/profile-bg-7c6e6a1672.jpg')"></div><img class="profile__avatar" src="https://wzhongke.github.io//img/sign-d1f802b4e8.jpg" alt="avatar"><h3 class="profile__name">壹冶知秋</h3><p class="profile__desc">Do not ride on fear...</p></div><ul class="nav-group show-on-medium-and-down menu"><li><a class="collapsible-header waves-effect waves-indigo" href="https://wzhongke.github.io//"><i class="material-icons">home</i> <span class="content">Home</span> <i class="material-icons">chevron_right</i></a></li><li><a class="collapsible-header waves-effect waves-indigo" href="https://wzhongke.github.io//archive/"><i class="material-icons">archive</i> <span class="content">Archive</span> <i class="material-icons">chevron_right</i></a></li><li><a class="collapsible-header waves-effect waves-indigo" href="https://wzhongke.github.io//about/"><i class="material-icons">person</i> <span class="content">About</span> <i class="material-icons">chevron_right</i></a></li><li><a class="collapsible-header waves-effect waves-indigo" href="https://wzhongke.github.io//post/%E7%A2%B0%E5%88%B0%E8%BF%87%E7%9A%84%E9%97%AE%E9%A2%98/"><i class="material-icons">bookmark</i> <span class="content">碰到过的问题</span> <i class="material-icons">chevron_right</i></a></li></ul><ul class="nav-group show-on-small tools"><li><a class="collapsible-header waves-effect waves-indigo modal-trigger" href="#modal-search"><i class="material-icons">search</i> <span class="content">Search</span> <i class="material-icons">chevron_right</i></a></li><li><a class="collapsible-header waves-effect waves-indigo" target="_blank" href="https://wzhongke.github.io/index.xml"><i class="material-icons">rss_feed</i> <span class="content">RSS Feed</span> <i class="material-icons">chevron_right</i></a></li></ul><ul class="collapsible nav-group" data-collapsible="accordion"><li><div class="collapsible-header waves-effect waves-indigo"><i class="material-icons">whatshot</i> <span class="content">Latest</span> <i class="material-icons angle">expand_more</i></div><div class="collapsible-body"><div class="collection"><a class="collection-item" href="https://wzhongke.github.io/post/">Posts</a> <a class="collection-item" href="https://wzhongke.github.io/post/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E6%80%9D%E8%80%83%E5%BF%AB%E4%B8%8E%E6%85%A2/">思考快与慢</a> <a class="collection-item" href="https://wzhongke.github.io/post/java/netty-%E5%AE%9E%E6%88%98/">netty 实战</a> <a class="collection-item" href="https://wzhongke.github.io/post/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E9%9D%9E%E6%9A%B4%E5%8A%9B%E6%B2%9F%E9%80%9A/">非暴力沟通</a> <a class="collection-item" href="https://wzhongke.github.io/post/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E4%BA%BA%E7%94%9F%E7%9A%84%E6%99%BA%E6%85%A7-%E5%8F%94%E6%9C%AC%E5%8D%8E/">人生的智慧_叔本华</a> <a class="collection-item" href="https://wzhongke.github.io/post/node/node%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/">node使用笔记</a> <a class="collection-item" href="https://wzhongke.github.io/post/node/typeorm/">typeorm</a> <a class="collection-item" href="https://wzhongke.github.io/post/java/spring-%E6%BA%90%E7%A0%81/">深入浅出 nodejs</a> <a class="collection-item" href="https://wzhongke.github.io/post/java/java%E5%A0%86%E5%86%85%E5%AD%98/">java 内存以及GC</a> <a class="collection-item" href="https://wzhongke.github.io/post/java/java%E8%AE%A1%E7%AE%97%E5%86%85%E5%AD%98/">java 使用代码计算内存</a></div></div></li><li><div class="collapsible-header waves-effect waves-indigo"><i class="material-icons"><i class="material-icons">class</i></i> <span class="content">Category </span><i class="material-icons angle">expand_more</i></div><div class="collapsible-body"><div class="collection"><a class="collection-item" href="https://wzhongke.github.io//categories/java">java<span class="badge">14</span></a> <a class="collection-item" href="https://wzhongke.github.io//categories/linux">linux<span class="badge">10</span></a> <a class="collection-item" href="https://wzhongke.github.io//categories/javascript">javascript<span class="badge">7</span></a> <a class="collection-item" href="https://wzhongke.github.io//categories/%E7%AE%97%E6%B3%95">算法<span class="badge">7</span></a> <a class="collection-item" href="https://wzhongke.github.io//categories/python">python<span class="badge">5</span></a> <a class="collection-item" href="https://wzhongke.github.io//categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">设计模式<span class="badge">5</span></a> <a class="collection-item" href="https://wzhongke.github.io//categories/mysql">mysql<span class="badge">4</span></a> <a class="collection-item" href="https://wzhongke.github.io//categories/other">other<span class="badge">4</span></a> <a class="collection-item" href="https://wzhongke.github.io//categories/%E5%B7%A5%E5%85%B7">工具<span class="badge">3</span></a> <a class="collection-item" href="https://wzhongke.github.io//categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0">读书笔记<span class="badge">3</span></a> <a class="collection-item" href="https://wzhongke.github.io//categories/css">css<span class="badge">2</span></a> <a class="collection-item" href="https://wzhongke.github.io//categories/sql">sql<span class="badge">2</span></a> <a class="collection-item" href="https://wzhongke.github.io//categories/error">error<span class="badge">1</span></a> <a class="collection-item" href="https://wzhongke.github.io//categories/markdown">markdown<span class="badge">1</span></a> <a class="collection-item" href="https://wzhongke.github.io//categories/nodejs">nodejs<span class="badge">1</span></a> <a class="collection-item" href="https://wzhongke.github.io//categories/svg">svg<span class="badge">1</span></a> <a class="collection-item" href="https://wzhongke.github.io//categories/vue">vue<span class="badge">1</span></a> <a class="collection-item" href="https://wzhongke.github.io//categories/%E6%97%85%E8%A1%8C">旅行<span class="badge">1</span></a> <a class="collection-item" href="https://wzhongke.github.io//categories/%E7%A4%BE%E7%A7%91">社科<span class="badge">1</span></a> <a class="collection-item" href="https://wzhongke.github.io//categories/%E7%BC%96%E7%A8%8B">编程<span class="badge">1</span></a></div></div></li><li><div class="collapsible-header waves-effect waves-indigo"><i class="material-icons"><i class="material-icons">local_offer</i></i> <span class="content">Tag </span><i class="material-icons angle">expand_more</i></div><div class="collapsible-body"><div class="collection"><a class="collection-item" href="https://wzhongke.github.io//tags/java">java<span class="badge">14</span></a> <a class="collection-item" href="https://wzhongke.github.io//tags/linux">linux<span class="badge">9</span></a> <a class="collection-item" href="https://wzhongke.github.io//tags/javascript">javascript<span class="badge">6</span></a> <a class="collection-item" href="https://wzhongke.github.io//tags/%E7%AE%97%E6%B3%95">算法<span class="badge">6</span></a> <a class="collection-item" href="https://wzhongke.github.io//tags/python">python<span class="badge">5</span></a> <a class="collection-item" href="https://wzhongke.github.io//tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">设计模式<span class="badge">5</span></a> <a class="collection-item" href="https://wzhongke.github.io//tags/mysql">mysql<span class="badge">4</span></a> <a class="collection-item" href="https://wzhongke.github.io//tags/other">other<span class="badge">4</span></a> <a class="collection-item" href="https://wzhongke.github.io//tags/%E5%B7%A5%E5%85%B7">工具<span class="badge">3</span></a> <a class="collection-item" href="https://wzhongke.github.io//tags/css">css<span class="badge">2</span></a> <a class="collection-item" href="https://wzhongke.github.io//tags/markdown">markdown<span class="badge">2</span></a> <a class="collection-item" href="https://wzhongke.github.io//tags/sql">sql<span class="badge">2</span></a> <a class="collection-item" href="https://wzhongke.github.io//tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0">读书笔记<span class="badge">2</span></a> <a class="collection-item" href="https://wzhongke.github.io//tags/error">error<span class="badge">1</span></a> <a class="collection-item" href="https://wzhongke.github.io//tags/nodejs">nodejs<span class="badge">1</span></a> <a class="collection-item" href="https://wzhongke.github.io//tags/svg">svg<span class="badge">1</span></a> <a class="collection-item" href="https://wzhongke.github.io//tags/%E6%97%85%E8%A1%8C">旅行<span class="badge">1</span></a></div></div></li></ul><ul class="nav-group external-link"><li><a class="collapsible-header waves-effect waves-indigo" href="https://github.com/wzhongke" target="_blank"><svg class="svg-icons svg-icons-github"><use xlink:href="#svg-icons-github"></use></svg> <span class="content">Github<small>@wzhongke</small></span> <i class="material-icons">chevron_right</i></a></li></ul></div></aside><main id="single" role="main" class="main-panel"><section class="container"><div class="inner"><div class="breadcrumbs" role="navigation" aria-label="breadcrumbs navigation"><a class="breadcrumb" href="https://wzhongke.github.io/"><i class="material-icons">location_on</i>Home</a> <a class="breadcrumb" href="https://wzhongke.github.io/post/">Post</a> <a class="breadcrumb" href="https://wzhongke.github.io/post/java/">Java</a> <span class="breadcrumb">netty 实战</span></div><section class="post-wrapper"><div class="toc-panel"><nav id="TableOfContents"><ul><li><a href="#channel"><code>channel</code></a></li><li><a href="#bindport"><code>bind(port)</code></a></li><li><a href="#初始化-channel">初始化 channel</a></li></ul></nav></div><div class="post"><div class="card"><div class="card-content"><span class="card-title">netty 实战 </span><span class="card-meta"><time><span>Wed Apr 15 2020</span></time><address><a href="https://wzhongke.github.io//categories/java">java</a>&nbsp;</address></span><article class="article"><h1 id="异步和事件驱动">异步和事件驱动</h1><p>Netty是一款<strong>异步的事件驱动的网络</strong>应用程序框架，支持快速地开发可维护的<strong>高性能的面向协议的服务器和客户端</strong></p><p>高性能的系统不仅要求超一流的编程技巧，还需要网络编程、多线程处理和并发的专业知识。</p><p>一个既是异步的又是事件驱动的系统会表现出一种特殊的、对我们来说极具价值的行为：它可以以任意的顺序响应在任意的时间点产生的事件。</p><p>Netty 的设计底蕴：</p><ul><li>非阻塞网络调用使得我们可以不必等待一个操作的完成。完全异步的I/O正是基于这个特性构建的，并且更进一步：异步方法会立即返回，并且在它完成时，会直接或者在稍后的某个时间点通知用户。</li><li>选择器使得我们能够通过较少的线程便可监视许多连接上的事件。</li></ul><p>Netty通过触发事件将Selector从应用程序中抽象出来，消除了所有本来将需要手动编写的派发代码。在内部，将会为每个Channel分配一个EventLoop，用以处理所有事件，包括：</p><ul><li>注册感兴趣的事件；</li><li>将事件派发给ChannelHandler；</li><li>安排进一步的动作</li></ul><h1 id="netty-源码">netty 源码</h1><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// 是 2 的指数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isPowerOfTwo</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> val<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>val <span style="color:#f92672">&amp;</span> <span style="color:#f92672">-</span>val<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> val<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>MultithreadEventExecutorGroup</code> 类中存贮着如下内容:</p><ul><li><code>EventExecutor[] children</code>: EventExecutor</li><li><code>Set&lt;EventExecutor&gt; readonlyChildren</code></li><li><code>AtomicInteger terminatedChildren</code></li><li><code>Promise&lt;?&gt; terminationFuture</code></li><li><code>EventExecutorChooserFactory.EventExecutorChooser chooser</code></li></ul><h1 id="nioeventloopgroup"><code>NioEventLoopGroup</code></h1><p>以下代码初始化了 <code>NioEventLoopGroup</code> 类，netty 做了很多工作</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">EventLoopGroup bossGroup <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> NioEventLoopGroup<span style="color:#f92672">();</span>
</code></pre></div><p>跟踪 <code>new NioEventLoopGroup()</code>:</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">NioEventLoopGroup</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> nThreads<span style="color:#f92672">,</span> Executor executor<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> SelectorProvider selectorProvider<span style="color:#f92672">,</span>
                         <span style="color:#66d9ef">final</span> SelectStrategyFactory selectStrategyFactory<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>nThreads<span style="color:#f92672">,</span> executor<span style="color:#f92672">,</span> selectorProvider<span style="color:#f92672">,</span> selectStrategyFactory<span style="color:#f92672">,</span> RejectedExecutionHandlers<span style="color:#f92672">.</span><span style="color:#a6e22e">reject</span><span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>发现其只是调用了父类的初始化方法，<code>chooserFactory</code> 使用的是 <code>DefaultEventExecutorChooserFactory</code>:</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#a6e22e">MultithreadEventLoopGroup</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> nThreads<span style="color:#f92672">,</span> Executor executor<span style="color:#f92672">,</span> Object<span style="color:#f92672">...</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// 线程数默认使用的是 CPU 核的2倍
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>nThreads <span style="color:#f92672">==</span> 0 <span style="color:#f92672">?</span> DEFAULT_EVENT_LOOP_THREADS <span style="color:#f92672">:</span> nThreads<span style="color:#f92672">,</span> executor<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">protected</span> <span style="color:#a6e22e">MultithreadEventExecutorGroup</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> nThreads<span style="color:#f92672">,</span> Executor executor<span style="color:#f92672">,</span>
                                        EventExecutorChooserFactory chooserFactory<span style="color:#f92672">,</span> Object<span style="color:#f92672">...</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>nThreads <span style="color:#f92672">&lt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span>String<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;nThreads: %d (expected: &gt; 0)&#34;</span><span style="color:#f92672">,</span> nThreads<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>executor <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// 使用默认的 线程工厂 初始化执行器
</span><span style="color:#75715e"></span>        executor <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadPerTaskExecutor<span style="color:#f92672">(</span>newDefaultThreadFactory<span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>

    children <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> EventExecutor<span style="color:#f92672">[</span>nThreads<span style="color:#f92672">];</span>

    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> nThreads<span style="color:#f92672">;</span> i <span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">boolean</span> success <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// 初始化执行器，返回的是 NioEventLoop 实例
</span><span style="color:#75715e"></span>            children<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> newChild<span style="color:#f92672">(</span>executor<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
            success <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// TODO: Think about if this is a good exception type
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalStateException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;failed to create a child event loop&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>success<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> j <span style="color:#f92672">&lt;</span> i<span style="color:#f92672">;</span> j <span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
                    children<span style="color:#f92672">[</span>j<span style="color:#f92672">].</span><span style="color:#a6e22e">shutdownGracefully</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> j <span style="color:#f92672">&lt;</span> i<span style="color:#f92672">;</span> j <span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
                    EventExecutor e <span style="color:#f92672">=</span> children<span style="color:#f92672">[</span>j<span style="color:#f92672">];</span>
                    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span>e<span style="color:#f92672">.</span><span style="color:#a6e22e">isTerminated</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                            e<span style="color:#f92672">.</span><span style="color:#a6e22e">awaitTermination</span><span style="color:#f92672">(</span>Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">MAX_VALUE</span><span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">SECONDS</span><span style="color:#f92672">);</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException interrupted<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#75715e">// Let the caller handle the interruption.
</span><span style="color:#75715e"></span>                        Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">interrupt</span><span style="color:#f92672">();</span>
                        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">// 工作线程选择器
</span><span style="color:#75715e"></span>    chooser <span style="color:#f92672">=</span> chooserFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">newChooser</span><span style="color:#f92672">(</span>children<span style="color:#f92672">);</span>

    <span style="color:#75715e">// 关闭监听器
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">final</span> FutureListener<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> terminationListener <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FutureListener<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">operationComplete</span><span style="color:#f92672">(</span>Future<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> future<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>terminatedChildren<span style="color:#f92672">.</span><span style="color:#a6e22e">incrementAndGet</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> children<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                terminationFuture<span style="color:#f92672">.</span><span style="color:#a6e22e">setSuccess</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">};</span>

    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>EventExecutor e<span style="color:#f92672">:</span> children<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        e<span style="color:#f92672">.</span><span style="color:#a6e22e">terminationFuture</span><span style="color:#f92672">().</span><span style="color:#a6e22e">addListener</span><span style="color:#f92672">(</span>terminationListener<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    Set<span style="color:#f92672">&lt;</span>EventExecutor<span style="color:#f92672">&gt;</span> childrenSet <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedHashSet<span style="color:#f92672">&lt;</span>EventExecutor<span style="color:#f92672">&gt;(</span>children<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">);</span>
    Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">addAll</span><span style="color:#f92672">(</span>childrenSet<span style="color:#f92672">,</span> children<span style="color:#f92672">);</span>
    readonlyChildren <span style="color:#f92672">=</span> Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">unmodifiableSet</span><span style="color:#f92672">(</span>childrenSet<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>newChild</code> 方法创建 <code>NioEventLoop extends SingleThreadEventLoop</code> 对象</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> EventLoop <span style="color:#a6e22e">newChild</span><span style="color:#f92672">(</span>Executor executor<span style="color:#f92672">,</span> Object<span style="color:#f92672">...</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
    EventLoopTaskQueueFactory queueFactory <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> 4 <span style="color:#f92672">?</span> <span style="color:#f92672">(</span>EventLoopTaskQueueFactory<span style="color:#f92672">)</span> args<span style="color:#f92672">[</span>3<span style="color:#f92672">]</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> NioEventLoop<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> executor<span style="color:#f92672">,</span> <span style="color:#f92672">(</span>SelectorProvider<span style="color:#f92672">)</span> args<span style="color:#f92672">[</span>0<span style="color:#f92672">],</span>
        <span style="color:#f92672">((</span>SelectStrategyFactory<span style="color:#f92672">)</span> args<span style="color:#f92672">[</span>1<span style="color:#f92672">]).</span><span style="color:#a6e22e">newSelectStrategy</span><span style="color:#f92672">(),</span> <span style="color:#f92672">(</span>RejectedExecutionHandler<span style="color:#f92672">)</span> args<span style="color:#f92672">[</span>2<span style="color:#f92672">],</span> queueFactory<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h1 id="serverbootstrap"><code>ServerBootstrap()</code></h1><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ServerBootstrap b <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ServerBootstrap<span style="color:#f92672">();</span>
<span style="color:#75715e">// bossGroup 是 parentGroup, workerGroup 是子group
</span><span style="color:#75715e"></span>b<span style="color:#f92672">.</span><span style="color:#a6e22e">group</span><span style="color:#f92672">(</span>bossGroup<span style="color:#f92672">,</span> workerGroup<span style="color:#f92672">)</span>
	<span style="color:#75715e">// 初始化 channelFactory，新建 channel 时使用 NioServerSocketChannel 类
</span><span style="color:#75715e"></span>	<span style="color:#f92672">.</span><span style="color:#a6e22e">channel</span><span style="color:#f92672">(</span>NioServerSocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
	<span style="color:#f92672">.</span><span style="color:#a6e22e">childHandler</span><span style="color:#f92672">(</span>handler<span style="color:#f92672">)</span>
	<span style="color:#75715e">// option 提供给NioServerSocketChannel用来接收进来的连接
</span><span style="color:#75715e"></span>	<span style="color:#f92672">.</span><span style="color:#a6e22e">option</span><span style="color:#f92672">(</span>ChannelOption<span style="color:#f92672">.</span><span style="color:#a6e22e">SO_BACKLOG</span><span style="color:#f92672">,</span> 128<span style="color:#f92672">)</span>
	<span style="color:#75715e">// childOption 是对父管道ServerChannel接收到的连接的配置
</span><span style="color:#75715e"></span>	<span style="color:#f92672">.</span><span style="color:#a6e22e">childOption</span><span style="color:#f92672">(</span>ChannelOption<span style="color:#f92672">.</span><span style="color:#a6e22e">SO_KEEPALIVE</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>

<span style="color:#75715e">// 绑定端口并开始接受请求
</span><span style="color:#75715e"></span>ChannelFuture f <span style="color:#f92672">=</span> b<span style="color:#f92672">.</span><span style="color:#a6e22e">bind</span><span style="color:#f92672">(</span>port<span style="color:#f92672">).</span><span style="color:#a6e22e">sync</span><span style="color:#f92672">();</span>
</code></pre></div><h2 id="channel"><code>channel</code></h2><p><code>channel(NioServerSocketChannel.class)</code> 定义了使用哪个 channel，主要内容是初始化了一个 channelFactory:</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> B <span style="color:#a6e22e">channel</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> C<span style="color:#f92672">&gt;</span> channelClass<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> channelFactory<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ReflectiveChannelFactory<span style="color:#f92672">&lt;</span>C<span style="color:#f92672">&gt;(</span>
            ObjectUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">checkNotNull</span><span style="color:#f92672">(</span>channelClass<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;channelClass&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#f92672">));</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>ReflectiveChannelFactory</code> 主要有两个内容：</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// 构造函数，定义了该工厂初始化哪个类
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ReflectiveChannelFactory</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> T<span style="color:#f92672">&gt;</span> clazz<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    ObjectUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">checkNotNull</span><span style="color:#f92672">(</span>clazz<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;clazz&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">constructor</span> <span style="color:#f92672">=</span> clazz<span style="color:#f92672">.</span><span style="color:#a6e22e">getConstructor</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>NoSuchMethodException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Class &#34;</span> <span style="color:#f92672">+</span> StringUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">simpleClassName</span><span style="color:#f92672">(</span>clazz<span style="color:#f92672">)</span> <span style="color:#f92672">+</span>
                <span style="color:#e6db74">&#34; does not have a public non-arg constructor&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// 使用默认构造器生成 channel 的实例
</span><span style="color:#75715e"></span><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> T <span style="color:#a6e22e">newChannel</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> constructor<span style="color:#f92672">.</span><span style="color:#a6e22e">newInstance</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable t<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ChannelException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Unable to create Channel from class &#34;</span> <span style="color:#f92672">+</span> constructor<span style="color:#f92672">.</span><span style="color:#a6e22e">getDeclaringClass</span><span style="color:#f92672">(),</span> t<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>childHandler</code>、<code>option</code>、<code>childOption</code> 只是将参数保存到 <code>ServerBootstrap</code></p><h2 id="bindport"><code>bind(port)</code></h2><p><code>bind(port)</code> 的主要代码在 <code>AbstractBootstrap.doBind()</code> 中</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> ChannelFuture <span style="color:#a6e22e">doBind</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> SocketAddress localAddress<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
	<span style="color:#75715e">// 使用 ReflectiveChannelFactory 初始化 channel，
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">final</span> ChannelFuture regFuture <span style="color:#f92672">=</span> initAndRegister<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">final</span> Channel channel <span style="color:#f92672">=</span> regFuture<span style="color:#f92672">.</span><span style="color:#a6e22e">channel</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>regFuture<span style="color:#f92672">.</span><span style="color:#a6e22e">cause</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> regFuture<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>regFuture<span style="color:#f92672">.</span><span style="color:#a6e22e">isDone</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// At this point we know that the registration was complete and successful.
</span><span style="color:#75715e"></span>        ChannelPromise promise <span style="color:#f92672">=</span> channel<span style="color:#f92672">.</span><span style="color:#a6e22e">newPromise</span><span style="color:#f92672">();</span>
        doBind0<span style="color:#f92672">(</span>regFuture<span style="color:#f92672">,</span> channel<span style="color:#f92672">,</span> localAddress<span style="color:#f92672">,</span> promise<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> promise<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Registration future is almost always fulfilled already, but just in case it&#39;s not.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> PendingRegistrationPromise promise <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PendingRegistrationPromise<span style="color:#f92672">(</span>channel<span style="color:#f92672">);</span>
        regFuture<span style="color:#f92672">.</span><span style="color:#a6e22e">addListener</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ChannelFutureListener<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#a6e22e">@Override</span>
            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">operationComplete</span><span style="color:#f92672">(</span>ChannelFuture future<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
                Throwable cause <span style="color:#f92672">=</span> future<span style="color:#f92672">.</span><span style="color:#a6e22e">cause</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cause <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// Registration on the EventLoop failed so fail the ChannelPromise directly to not cause an
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// IllegalStateException once we try to access the EventLoop of the Channel.
</span><span style="color:#75715e"></span>                    promise<span style="color:#f92672">.</span><span style="color:#a6e22e">setFailure</span><span style="color:#f92672">(</span>cause<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// Registration was successful, so set the correct executor to use.
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// See https://github.com/netty/netty/issues/2586
</span><span style="color:#75715e"></span>                    promise<span style="color:#f92672">.</span><span style="color:#a6e22e">registered</span><span style="color:#f92672">();</span>

                    doBind0<span style="color:#f92672">(</span>regFuture<span style="color:#f92672">,</span> channel<span style="color:#f92672">,</span> localAddress<span style="color:#f92672">,</span> promise<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">});</span>
        <span style="color:#66d9ef">return</span> promise<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="初始化-channel">初始化 channel</h2><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">final</span> ChannelFuture <span style="color:#a6e22e">initAndRegister</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    Channel channel <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
    	<span style="color:#75715e">// 使用工厂方法初始化 channel，也即是初始化 `NioServerSocketChannel`
</span><span style="color:#75715e"></span>        channel <span style="color:#f92672">=</span> channelFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">newChannel</span><span style="color:#f92672">();</span>
        init<span style="color:#f92672">(</span>channel<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable t<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>channel <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// channel can be null if newChannel crashed (eg SocketException(&#34;too many open files&#34;))
</span><span style="color:#75715e"></span>            channel<span style="color:#f92672">.</span><span style="color:#a6e22e">unsafe</span><span style="color:#f92672">().</span><span style="color:#a6e22e">closeForcibly</span><span style="color:#f92672">();</span>
            <span style="color:#75715e">// as the Channel is not registered yet we need to force the usage of the GlobalEventExecutor
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> DefaultChannelPromise<span style="color:#f92672">(</span>channel<span style="color:#f92672">,</span> GlobalEventExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span><span style="color:#f92672">).</span><span style="color:#a6e22e">setFailure</span><span style="color:#f92672">(</span>t<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// as the Channel is not registered yet we need to force the usage of the GlobalEventExecutor
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> DefaultChannelPromise<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> FailedChannel<span style="color:#f92672">(),</span> GlobalEventExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span><span style="color:#f92672">).</span><span style="color:#a6e22e">setFailure</span><span style="color:#f92672">(</span>t<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">// 在 NioEventLoop (MultithreadEventLoopGroup) 中注册 channel
</span><span style="color:#75715e"></span>    ChannelFuture regFuture <span style="color:#f92672">=</span> config<span style="color:#f92672">().</span><span style="color:#a6e22e">group</span><span style="color:#f92672">().</span><span style="color:#a6e22e">register</span><span style="color:#f92672">(</span>channel<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>regFuture<span style="color:#f92672">.</span><span style="color:#a6e22e">cause</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>channel<span style="color:#f92672">.</span><span style="color:#a6e22e">isRegistered</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            channel<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            channel<span style="color:#f92672">.</span><span style="color:#a6e22e">unsafe</span><span style="color:#f92672">().</span><span style="color:#a6e22e">closeForcibly</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">// If we are here and the promise is not failed, it&#39;s one of the following cases:
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 1) If we attempted registration from the event loop, the registration has been completed at this point.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//    i.e. It&#39;s safe to attempt bind() or connect() now because the channel has been registered.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 2) If we attempted registration from the other thread, the registration request has been successfully
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//    added to the event loop&#39;s task queue for later execution.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//    i.e. It&#39;s safe to attempt bind() or connect() now:
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//         because bind() or connect() will be executed *after* the scheduled registration task is executed
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//         because register(), bind(), and connect() are all bound to the same thread.
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">return</span> regFuture<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>channelFactory.newChannel()</code> 使用默认构造器创建了 <code>NioServerSocketChannel</code> 对象 初始化 <code>NioServerSocketChannel</code>，打开 serverSocketChannel，并在其父类中初始化 <code>pipeline</code> 以及 初始化 <code>NioServerSocketChannelConfig</code>:</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#a6e22e">AbstractChannel</span><span style="color:#f92672">(</span>Channel parent<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">parent</span> <span style="color:#f92672">=</span> parent<span style="color:#f92672">;</span>
    id <span style="color:#f92672">=</span> newId<span style="color:#f92672">();</span>
    <span style="color:#75715e">// 不同子类实现各自的 AbstractUnsafe，是消息收发的实现。nio 中在 `AbstractNioMessageChannel` 类中
</span><span style="color:#75715e"></span>    unsafe <span style="color:#f92672">=</span> newUnsafe<span style="color:#f92672">();</span>
    <span style="color:#75715e">// 初始化 pipeline
</span><span style="color:#75715e"></span>    pipeline <span style="color:#f92672">=</span> newChannelPipeline<span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>初始化 <code>ChannelPipeline</code>:</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> <span style="color:#a6e22e">DefaultChannelPipeline</span><span style="color:#f92672">(</span>Channel channel<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">channel</span> <span style="color:#f92672">=</span> ObjectUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">checkNotNull</span><span style="color:#f92672">(</span>channel<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;channel&#34;</span><span style="color:#f92672">);</span>
    succeededFuture <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SucceededChannelFuture<span style="color:#f92672">(</span>channel<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
    voidPromise <span style="color:#f92672">=</span>  <span style="color:#66d9ef">new</span> VoidChannelPromise<span style="color:#f92672">(</span>channel<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
    <span style="color:#75715e">// pipeline 的头和尾
</span><span style="color:#75715e"></span>    tail <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TailContext<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
    head <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HeadContext<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>

    head<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> tail<span style="color:#f92672">;</span>
    tail<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> head<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>在 <code>init(channel)</code> 中主要在 pipeline 中添加了如下的 channel：</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">p<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ChannelInitializer<span style="color:#f92672">&lt;</span>Channel<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initChannel</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> Channel ch<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> ChannelPipeline pipeline <span style="color:#f92672">=</span> ch<span style="color:#f92672">.</span><span style="color:#a6e22e">pipeline</span><span style="color:#f92672">();</span>
        ChannelHandler handler <span style="color:#f92672">=</span> config<span style="color:#f92672">.</span><span style="color:#a6e22e">handler</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>handler <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            pipeline<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span>handler<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        ch<span style="color:#f92672">.</span><span style="color:#a6e22e">eventLoop</span><span style="color:#f92672">().</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#a6e22e">@Override</span>
            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                pipeline<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ServerBootstrapAcceptor<span style="color:#f92672">(</span>
                        ch<span style="color:#f92672">,</span> currentChildGroup<span style="color:#f92672">,</span> currentChildHandler<span style="color:#f92672">,</span> currentChildOptions<span style="color:#f92672">,</span> currentChildAttrs<span style="color:#f92672">));</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">});</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">});</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// SingleThreadEventLoop 注册 channel
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> ChannelFuture <span style="color:#a6e22e">register</span><span style="color:#f92672">(</span>Channel channel<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> register<span style="color:#f92672">(</span>channel<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> DefaultChannelPromise<span style="color:#f92672">(</span>channel<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">));</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> ChannelFuture <span style="color:#a6e22e">register</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> Channel channel<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> ChannelPromise promise<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>channel <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NullPointerException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;channel&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>promise <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NullPointerException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;promise&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// AbstractNioMessageChannel.NioMessageUnsafe
</span><span style="color:#75715e"></span>    channel<span style="color:#f92672">.</span><span style="color:#a6e22e">unsafe</span><span style="color:#f92672">().</span><span style="color:#a6e22e">register</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> promise<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> promise<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// AbstractChannel.AbstractUnsafe
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">register0</span><span style="color:#f92672">(</span>ChannelPromise promise<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// check if the channel is still open as it could be closed in the mean time when the register
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// call was outside of the eventLoop
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>promise<span style="color:#f92672">.</span><span style="color:#a6e22e">setUncancellable</span><span style="color:#f92672">()</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>ensureOpen<span style="color:#f92672">(</span>promise<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">boolean</span> firstRegistration <span style="color:#f92672">=</span> neverRegistered<span style="color:#f92672">;</span>
        doRegister<span style="color:#f92672">();</span>
        neverRegistered <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        registered <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>

        <span style="color:#75715e">// Ensure we call handlerAdded(...) before we actually notify the promise. This is needed as the
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// user may already fire events through the pipeline in the ChannelFutureListener.
</span><span style="color:#75715e"></span>        pipeline<span style="color:#f92672">.</span><span style="color:#a6e22e">invokeHandlerAddedIfNeeded</span><span style="color:#f92672">();</span>

        safeSetSuccess<span style="color:#f92672">(</span>promise<span style="color:#f92672">);</span>
        <span style="color:#75715e">// pipeline 中传播 注册的消息
</span><span style="color:#75715e"></span>        pipeline<span style="color:#f92672">.</span><span style="color:#a6e22e">fireChannelRegistered</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">// Only fire a channelActive if the channel has never been registered. This prevents firing
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// multiple channel actives if the channel is deregistered and re-registered.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isActive<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>firstRegistration<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                pipeline<span style="color:#f92672">.</span><span style="color:#a6e22e">fireChannelActive</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>config<span style="color:#f92672">().</span><span style="color:#a6e22e">isAutoRead</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// This channel was registered before and autoRead() is set. This means we need to begin read
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// again so that we process inbound data.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">//
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// See https://github.com/netty/netty/issues/4805
</span><span style="color:#75715e"></span>                beginRead<span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable t<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Close the channel directly to avoid FD leak.
</span><span style="color:#75715e"></span>        closeForcibly<span style="color:#f92672">();</span>
        closeFuture<span style="color:#f92672">.</span><span style="color:#a6e22e">setClosed</span><span style="color:#f92672">();</span>
        safeSetFailure<span style="color:#f92672">(</span>promise<span style="color:#f92672">,</span> t<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>channel.unsafe().register(this, promise);</code> 是在 <code>AbstractNioMessageChannel.NioMessageUnsafe</code> 中注册了 channel</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// AbstractNioChannel 注册 channel
</span><span style="color:#75715e"></span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doRegister</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">boolean</span> selected <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;;)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            selectionKey <span style="color:#f92672">=</span> javaChannel<span style="color:#f92672">().</span><span style="color:#a6e22e">register</span><span style="color:#f92672">(((</span>NioEventLoop<span style="color:#f92672">)</span> eventLoop<span style="color:#f92672">().</span><span style="color:#a6e22e">unwrap</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">selector</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>CancelledKeyException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>selected<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Force the Selector to select now as the &#34;canceled&#34; SelectionKey may still be
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// cached and not removed because no Select.select(..) operation was called yet.
</span><span style="color:#75715e"></span>                <span style="color:#f92672">((</span>NioEventLoop<span style="color:#f92672">)</span> eventLoop<span style="color:#f92672">().</span><span style="color:#a6e22e">unwrap</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">selectNow</span><span style="color:#f92672">();</span>
                selected <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// We forced a select operation on the selector before but the SelectionKey is still cached
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// for whatever reason. JDK bug ?
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">throw</span> e<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>ServerBootstrap</code> 主要的逻辑在 <code>AbstractBootstrap</code> 类中</p><p><code>AbstractBootstrap.doBind()</code> 完成了绑定端口的操作</p><p>并通过映射新建了 <code>NioServerSocketChannel</code> 类，初始化的过程中监听 socket，使用 <code>new DefaultChannelPipeline(this)</code> 初始化 pipeline，并将自己添加到 <code>pipeline</code> 中。</p><p>一个 channel 对应一个 pipeline</p><p><code>DefaultChannelPipeline.addLast0()</code> 将 channelHandler 加到 pipeline 中</p></article></div><div class="card-action"><i class="material-icons">local_offer</i> <a class="tag" href="https://wzhongke.github.io//tags/java">#java</a>&nbsp;</div><div class="card-action"><div class="comments"><div id="disqus_thread"></div></div><script type="text/javascript">var disqus_shortname = 'wzhongke';

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div><div class="pagination-single"><span class="pagination-item previous"><i class="material-icons">navigate_before</i> <a href="https://wzhongke.github.io/post/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E6%80%9D%E8%80%83%E5%BF%AB%E4%B8%8E%E6%85%A2/" rel="prev">思考快与慢</a> </span><span class="pagination-item next"><i class="material-icons">navigate_next</i> <a href="https://wzhongke.github.io/post/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E9%9D%9E%E6%9A%B4%E5%8A%9B%E6%B2%9F%E9%80%9A/" rel="next">非暴力沟通</a></span></div></div></section></div></section><footer class="page-footer"><div class="container"><div class="row"><div class="col l6 s12"><h5 class="white-text">World of Wang</h5><p class="grey-text text-lighten-4">Theme <a href="https://github.com/stkevintan/hugo-YAMT-theme" target="_blank">YAMT</a> designed by <a href="https://github.com/stkevintan" target="_blank">Kevin Tan</a> with ❤</p></div><div class="col l4 offset-l2 s12"><h5 class="white-text">My Friends</h5><ul><li><a class="grey-text text-lighten-3" href="https://frantic1048.logdown.com/" target="_blank">Frantic1048</a></li></ul></div></div></div><div class="footer-copyright"><div class="container">Copyright@Kevin Tan</div></div></footer></main><script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script type="text/javascript" src="//dlweb.sogoucdn.com/common/lib/jquery/jquery-1.11.0.min.js"></script><script type="text/javascript" src="//cdn.bootcss.com/lunr.js/2.1.2/lunr.min.js"></script><script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']]
      }
    });</script><script type="text/javascript" src="https://wzhongke.github.io//js/materialize.min.js"></script><script type="text/javascript" src="https://wzhongke.github.io//js/index-1c463e212c.js"></script><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-9350854994277981",
        enable_page_level_ads: true
    });</script></body></html>